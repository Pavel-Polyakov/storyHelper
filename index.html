<!DOCTYPE html>
<html>
<head>
    <title>Story Helper</title>
    <style>
        #result-image {
            width: 1080px;
            height: 1920px;
            margin: auto;
        }
    </style>

    <!--    https://github.com/davidenke/context-filter-polyfill    -->
    <script src="https://cdn.jsdelivr.net/npm/context-filter-polyfill/dist/index.min.js"></script>

    <!--    bootstrap   -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
</head>
<body>

    <div class="container">
        <div class="row">
            <div class="col">
                <h3 class="text-center">Select a horizontal photo to make it Instagram-stories compatible</h3>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col text-center">
                <input type="file" class="form-control text-center form-control-lg" id="image-input" />
            </div>
        </div>

        <div class="row mt-3">
            <div class="col text-center">
                <div class="d-flex justify-content-center">
                  <div class="spinner-border" role="status" style="display: none" id="spinner">
                    <span class="sr-only"></span>
                  </div>
                </div>
                <div id="result-image" class="text-center"></div>
            </div>
        </div>

    </div>

    <script>
        function applyBlur(image, blurRadius) {
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");
            const blurCanvas = document.createElement("canvas");
            const blurCtx = blurCanvas.getContext("2d");

            const width = image.width;
            const height = image.height;

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(image, 0, 0);

            blurCanvas.width = width;
            blurCanvas.height = height;
            blurCtx.filter = `blur(${blurRadius}px)`;
            blurCtx.drawImage(canvas, 0, 0, width, height);

            return blurCanvas;
        }

        function resizeImage(srcImage, maxHeight) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");

                image.onload = () => {
                    const width = image.width;
                    const height = image.height;

                    const scaleFactor = maxHeight / height;
                    const newWidth = width * scaleFactor;
                    const newHeight = maxHeight;

                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    ctx.drawImage(image, 0, 0, newWidth, newHeight);

                    resolve(canvas.toDataURL());
                };

                image.onerror = reject;
                image.src = srcImage;
            });
        }

        function createResultImage(srcImage, fileName) {
            const resultDiv = document.getElementById("result-image");

            const resultCanvas = document.createElement("canvas");
            const resultCtx = resultCanvas.getContext("2d");

            resultCanvas.width = 1080;
            resultCanvas.height = 1920;

            const image = new Image();
            image.onload = () => {
                const { width, height } = image;

                const xOffset = (width - 1080) / 2;
                const yOffset = (height - 1920) / 2;

                const blurredImage = applyBlur(image, 15);
                resultCtx.drawImage(blurredImage, xOffset, yOffset, 1080, 1920, 0, 0, 1080, 1920);

                // Decrease brightness
                resultCtx.globalCompositeOperation = "color-burn";
                resultCtx.fillStyle = "rgba(0, 0, 0, 0.2)";
                resultCtx.fillRect(0, 0, 1080, 1920);
                resultCtx.globalCompositeOperation = "source-over";

                // Add vignette
                const gradient = resultCtx.createRadialGradient(540, 960, 0, 540, 960, 1000);
                gradient.addColorStop(0, "rgba(0, 0, 0, 0)");
                gradient.addColorStop(1, "rgba(0, 0, 0, 0.4)");
                resultCtx.fillStyle = gradient;
                resultCtx.fillRect(0, 0, 1080, 1920);

                const sourceImage = new Image();
                sourceImage.onload = () => {
                    const maxWidth = 1000;
                    const scaleFactor = maxWidth / sourceImage.width;
                    const newWidth = maxWidth;
                    const newHeight = sourceImage.height * scaleFactor;

                    const xPosition = (1080 - newWidth) / 2;
                    const yPosition = (1920 - newHeight) / 2;

                    const borderWidth = 1;
                    const borderColor = "rgba(0, 0, 0, 1)";
                    const shadowColor = "rgba(0, 0, 0, 1)";
                    const shadowBlur = 50;

                    resultCtx.shadowColor = shadowColor;
                    resultCtx.shadowBlur = shadowBlur;
                    resultCtx.strokeStyle = borderColor;
                    resultCtx.lineWidth = borderWidth;

                    resultCtx.drawImage(sourceImage, xPosition, yPosition, newWidth, newHeight);
                    resultCtx.strokeRect(xPosition, yPosition, newWidth, newHeight);

                    // Create a download link for the final image
                    const downloadLink = document.createElement("a");
                    const resultFileName = fileName.replace(/\.[^/.]+$/, "") + "-storyHelper.jpg";
                    const resultImage = resultCanvas.toDataURL("image/jpeg");
                    downloadLink.href = resultImage;
                    downloadLink.download = resultFileName;

                    var image = new Image();
                    image.src = resultImage;
                    downloadLink.appendChild(image);
                    resultDiv.appendChild(downloadLink);

                    var loader = document.getElementById("spinner");
                    loader.style.display = "none";
                };

                sourceImage.src = srcImage;
            };

            image.src = srcImage;
        }

        function handleImageUpload(event) {
            var loader = document.getElementById("spinner");
            loader.style.display = "block";

            const file = event.target.files[0];
            const fileName = file.name;

            const reader = new FileReader();

            reader.onload = async (readerEvent) => {
                const resizedImage = await resizeImage(readerEvent.target.result, 1920);
                createResultImage(resizedImage, fileName);
            };

            if (file) {
                reader.readAsDataURL(file);
            }
        }

        const imageInput = document.getElementById("image-input");
        imageInput.addEventListener("change", handleImageUpload);
    </script>
</body>
</html>
